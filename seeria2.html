<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>SEERIA</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script>
		function fixStrs(row) {
			for (var i = 0; i < row.length; i++) {
				if (row[i][0] == '"') {
					var rep = '';
					for (var j = i; j < row.length; j++) {
						if (j != i)
							rep += ',';
						rep += row[j];
						if (rep[rep.length - 1] == '"') {
							row.splice(i, j - i + 1, rep.substring(1, rep.length - 1));
						}
					}
				}
			}
			return row;
		}
		
		// http://stackoverflow.com/questions/3870019/javascript-parser-for-a-string-which-contains-ini-data
		function parseINIString(data) {
			var regex = {
				section: /^\s*\[\s*([^\]]*)\s*\]\s*$/,
				param: /^\s*([\w\.\-\_]+)\s*=\s*(.*?)\s*$/,
				comment: /^\s*;.*$/
			};
			var value = {};
			var lines = data.split(/\r\n|\r|\n/);
			var section = null;
			
			lines.forEach(function(line) {
				if (line.length == 0) {
					return;
				}
				else if (regex.comment.test(line)) {
					return;
				}
				else if (regex.param.test(line)) {
					var match = line.match(regex.param);
					if(section) {
						var arr = fixStrs(match[2].split(','));
						arr.splice(0, 0, match[1]);
						value[section].push(arr);
					}
				}
				else if (regex.section.test(line)) {
					var match = line.match(regex.section);
					value[match[1]] = [];
					section = match[1];
				}
				else if(section) {
					value[section].push(line.split(','));
				}
			});
			return value;
		}
		
		// http://stackoverflow.com/questions/4359639/eval-with-variables-from-an-object-in-the-scope
		function evalVars(func, vars) {
			return new Function("v", "with(Math) { with (v) { return (" + func +")}}")(vars);
		}
		
		function sqr(x) {
			return x * x;
		}
		
		function ln(x) {
			return Math.log(x);
		}
		
		function lg(x) {
			return Math.log(x) / Math.log(10);
		}
		
		function toHtml(str) {
			var newStr = '';
			var tag = 'n';
			for (var i = 0; i < str.length; i++) {
				if (str[i] == '\\') {
					if (tag == 'n') {
						
					}
					else if (tag == 'y') {
						newStr += '</sup>';
					}
					else if (tag == 'a') {
						newStr += '</sub>';
					}
					else if (tag == 's') {
						newStr += '</u>';
					}
					else if (tag == 'i') {
						newStr += '</i>';
					}
					
					var oldtag = tag;
					
					i++;
					tag = str[i];
					if (oldtag != tag) {
						if (tag == 'n') {
							
						}
						else if (tag == 'y') {
							newStr += '<sup>';
						}
						else if (tag == 'a') {
							newStr += '<sub>';
						}
						else if (tag == 's') {
							newStr += '<u>';
						}
						else if (tag == 'i') {
							newStr += '<i>';
						}
					}
					else {
						tag = 'n';
					}
				}
				else {
					/*if (tag == 's') {
						newStr += String.fromCharCode(str[i].charCodeAt(0) + 0x0390 - 0x40 - 1);
						//console.log(str[i].charCodeAt(0) + ' ' + (str[i].charCodeAt(0) + 0x0390 - 0x40));
						//newStr += str[i];
					}
					else {*/
						newStr += str[i];
					//}
				}
			}
			if (tag == 'n') {
				
			}
			else if (tag == 'y') {
				newStr += '</sup>';
			}
			else if (tag == 'a') {
				newStr += '</sub>';
			}
			else if (tag == 's') {
				newStr += '</u>';
			}
			else if (tag == 'i') {
				newStr += '</i>';
			}
			return newStr;
		}
		
		function sigFigs(n, sig) {
			var mult = Math.pow(10, sig - Math.floor(Math.log(n) / Math.LN10) - 1);
			return Math.round(n * mult) / mult;
		}
		
		var ini;
		
		function loadSry(filename) {
			$('#steps').html('');
			$.get(filename, function(data) {
				ini = parseINIString(data);
				var val = $('#variant option:selected').val();
				if (val != '')
					loadVariant(val);
			}, 'text');
		}
		
		function loadVariant(variant) {
			_gaq.push(['_trackEvent', 'Ylesanne', $('#nimi option:selected').text(), (parseInt(variant, 10) + 1).toString()]);
			
			$('#steps').html('');
			
			var andmed;
			var vars = {};
			if (variant != 'Valemid')
				andmed = ini.Andmed[variant];
			
			for (var i = 0; i < ini.Kysimused.length; i++) {
				var sym = ini.Kysimused[i][0];
				var kysNr = ini.Kysimused[i][1];
				var kys = ini.Kysimused[i][2];
				var tahis = ini.Kysimused[i][3];
				var yhik = ini.Kysimused[i][4];
				var exp = ini.Kysimused[i][5];
				var tyveNr = ini.Kysimused[i][6];
				var valem = ini.Kysimused[i][7];
				var e = valem;
				
				if (variant != 'Valemid') {
					if (valem.indexOf('^') != -1)
						alert('shit');
					
					for (var j = 0; j < andmed.length; j++) {
						e = e.replace('#' + (j + 1).toString(), andmed[j]);
					}
					
					var ret = evalVars(e, vars);
					vars[sym] = ret;
				}
				
				if (kysNr >= 0)
				{
					kysNr = (kysNr == 0 ? "A" : (kysNr.toString())); 
					var str;
					if (variant == 'Valemid')
						str = '<b>' + kysNr + ')</b> ' + toHtml(kys) + ' (' + sym + '): <b>' + toHtml(tahis) + '</b> = ' + valem + ' <b>[' + toHtml(yhik) + ']</b>';
					else
						str = '<b>' + kysNr + ')</b> ' + toHtml(kys) + ' (' + sym + '): <b>' + toHtml(tahis) + '</b> = ' + valem + ' = <b>' + sigFigs(ret, 7).toString() + ' ' + toHtml(yhik) + '</b>';
					
					$('#steps').append($('<li></li>').html(str));
				}
			}
		}
		
		
		function loadNimed() {
			$.get('NIMED.TXT', function(data) {
				var lines = data.split(/\r\n|\r|\n/);
				lines.forEach(function (line) {
					if (line.length == 0)
						return;
					var pieces = line.split('\t');
					$('#nimi').append($('<option></option>').val(pieces[0]).text(pieces[1]));
				});
				
				$('#nimi').change(function(ev) {
					var val = $('#nimi option:selected').val();
					if (val != '')
						loadSry(val);
				});
				
				//loadSry($('#nimi option:selected').val());
				
				$('#variant').change(function(ev) {
					var val = $('#variant option:selected').val();
					if (val != '' && ini)
						loadVariant(val);
				});
			}, 'text');
		}

		$(function () {
			loadNimed();
			
			for (var i = 0; i < 36; i++) {
				$('#variant').append($('<option></option>').val(i).text(i + 1));
			}
			
			
		});
	</script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35281071-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</head>
<body>
	<h2 style="color: red;">Vastuste &otilde;igsus pole garanteeritud</h2>
	<select id="nimi">
		<option value="">---VALI &Uuml;LESANNE---</option>
	</select>
	<select id="variant">
		<option value="">---VALI VARIANT---</option>
		<option value="Valemid">Valemid</option>
	</select>
	<ul style="list-style-type: none;" id="steps">
	</ul>
</body>
</html>